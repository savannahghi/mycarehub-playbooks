---

- name: Install and configure Teleport service
  block:
    - name: "Download Teleport's PGP public key"
      ansible.builtin.get_url:
        dest: "/usr/share/keyrings/teleport-archive-keyring.asc"
        force: yes
        group: root
        owner: root
        url: "{{ teleport_pgp_key_download_url }}"

    - name: Add Teleport APT repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/teleport-archive-keyring.asc] https://apt.releases.teleport.dev/{{ ansible_distribution|lower }} {{ ansible_distribution_release }} stable/v{{ teleport_major_version }}"
        state: present
        update_cache: yes

    - name: Install Teleport
      ansible.builtin.apt:
        name: teleport
        state: latest

    - name: Setup systemd service for Teleport
      ansible.builtin.template:
        dest: "/etc/systemd/system/teleport.service"
        group: root
        mode: "u=rw,g=rw,o=r"
        owner: root
        src: "teleport.service"
  become: true
  tags: ["teleport"]
