---

- name: Check if required variables have been defined
  ansible.builtin.fail:
    msg: "{{ item.name }} is not defined"
  loop:
    - { name: "teleport_master_ca_pin", value: "{{ teleport_master_ca_pin }}" }
    - { name: "teleport_node_auth_token", value: "{{ teleport_node_auth_token }}" }
    - { name: "facility_mfl", value: "{{ facility_mfl }}" }
    - { name: "facility_name", value: "{{ facility_name }}" }
  when: not item.value
  tags: ["fyj_teleport_node"]

- name: Setup Teleport config file
  ansible.builtin.template:
    dest: /etc/teleport_config.yaml
    group: root
    mode: "u=rw,g=rw,o=r"
    owner: root
    src: teleport.yaml
  become: yes
  tags: ["fyj_teleport_node"]

- name: Enable Teleport service
  ansible.builtin.systemd:
    enabled: yes
    name: teleport
  become: yes
  tags: ["fyj_teleport_node"]
