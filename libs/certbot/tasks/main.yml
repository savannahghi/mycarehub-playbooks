---

- name: Remove old certbot packages
  ansible.builtin.apt:
      name: certbot
      state: absent
  become: true
  tags: ["certbot"]

- name: Install snapd if not present
  ansible.builtin.apt:
      name: snapd
      state: present
      update_cache: yes
  become: true
  tags: ["certbot"]

- name: Install snap core
  ansible.builtin.shell:
      cmd: "snap install core"
  become: true
  tags: ["certbot"]

- name: Update snapd
  ansible.builtin.shell:
      cmd: "snap refresh core"
  become: true
  tags: ["certbot"]

- name: Install certbot
  ansible.builtin.shell:
      cmd: "snap install --classic certbot"
  become: true
  tags: ["certbot"]

- name: Prepare certbot command
  ansible.builtin.file:
      src: "/snap/bin/certbot"
      dest: "/usr/bin/certbot"
      state: link
      owner: "root"
      group: "root"
  become: true
  tags: ["certbot"]

- name: Trust certbot plugin.
  ansible.builtin.shell:
      cmd: "snap set certbot trust-plugin-with-root=ok"
  become: true
  tags: ["certbot"]

- name: Install certbot-dns-google to allow for wildcard domain certs.
  ansible.builtin.shell:
      cmd: "snap install certbot-dns-google"
  become: true
  tags: ["certbot"]

