---

- name: Test WebADT setup
  hosts: test_servers
  pre_tasks:
    - name: Create deploy user
      ansible.builtin.user: name={{ deploy_user }} groups=www-data,sudo state=present
      become: true
    - name: Add application user group
      ansible.builtin.group: name={{ app_user_group }} state=present system=yes
      become: true
    - name: Add application user
      ansible.builtin.user: create_home=yes group={{ app_user_group }} home=/home/{{ app_user }} name={{ app_user }} shell=/bin/bash state=present system=yes
      become: true
  post_tasks:
    - name: Deploy successful, remove lock_file
      ansible.builtin.file: path={{ lock_file_path }} state=absent
      become: true
  roles:
    - common
    - role: apache_httpd
      vars:
        apache_httpd_server_user: "{{ app_user }}"
        apache_httpd_server_user_group: "{{ app_user_group }}" 
  strategy: free
  vars:
    app_db_name: testadt
    app_db_user: adt
    app_db_user_password: insecure_test_password
    app_user: apache2
    app_user_group: apache2
    deploy_user: deploy
    force_ignore_lock: false
    lock_file_path: /tmp/ansible-test-web-adt-setup.lock

  tasks:
    - name: Install and set up WebADT
      import_role:
        name: web_adt
      vars:
        web_adt_apache_httpd_document_root: "{{ apache_httpd_document_root }}"
        web_adt_apache_httpd_server_user: "{{ app_user }}"
        web_adt_apache_httpd_server_user_group: "{{ app_user_group }}"
        web_adt_db_user: "{{ app_db_user }}"
        web_adt_db_user_password: "{{ app_db_user_password }}"
      tags: ["test_web_adt_setup"]
