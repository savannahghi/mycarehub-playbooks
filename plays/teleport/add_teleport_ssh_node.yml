---
# FOR TELEPORT ADMINS:
#
# You might need to run sudo tctl tokens add --type=node before running this
# playbook. Also ensure you've placed Teleport vars in a <new_server>.yml file
# under inventories/infrastructure/host_vars
#
# ansible-playbook -i inventories/infrastructure -l <new_server> -vvv add_teleport_ssh_node.yml

- name: Setup Teleport SSH Service on a node
  hosts: teleport_edge_servers
  roles:
    - common
    - teleport_ssh_service
  strategy: free

  tasks:    
    # If you're redeploying new Teleport settings to a server with
    # Teleport running, this task will execute but show as failed
    # due to connection problems since the Teleport connection will
    # break on service restart
    - name: Enable and restart Teleport service
      ansible.builtin.systemd_service:
        daemon_reload: yes
        enabled: yes
        name: teleport
        scope: system
        state: restarted
      become: yes
      ignore_errors: yes
      tags: ["teleport_node"]
