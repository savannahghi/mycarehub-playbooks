---

- name: Test Eclipse Jetty installation and setup
  hosts: test_servers
  pre_tasks:
    - name: Get lock file stats
      ansible.builtin.stat: path={{ lock_file_path }}
      become: yes
      register: lock_file_stats
    - name: Ensure another installation is not running
      ansible.builtin.fail: msg="Another similar installation appears to be in-progress"
      when: lock_file_stats.stat.exists and not force_ignore_lock
    - name: Create deploy user
      ansible.builtin.user: name={{ deploy_user }} groups=www-data,sudo state=present
      become: true
  post_tasks:
    - name: Deploy successful, remove lock_file
      ansible.builtin.file: path={{ lock_file_path }} state=absent
      become: true
  roles:
    - common
  strategy: free
  vars:
    deploy_user: deploy
    force_ignore_lock: false
    lock_file_path: /tmp/ansible-test-eclipse-jetty-setup.lock

  tasks:
    - name: Install and set up Jetty Home
      import_role:
        name: jetty_home
      tags: ["test_jetty_home"]
